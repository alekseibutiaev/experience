/*
 * usb_module.c
 *
 *  Created on: Apr 17, 2021
 *      Author: butiaev
 */

#include <string.h>
#include "usbh_def.h"
#include "usbh_hid.h"
#include "usbh_hid_keyboard.h"

key_leds_t leds = { 0 };

extern uint8_t zx_keys[256];

const membrane_t membrane[256] = {
/*00*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*04*/  {0xFD, 0xFE, 0xFF, 0xFF}, /*A */ {0x7F, 0xEF, 0xFF, 0xFF}, /*B */ {0xFE, 0xF7, 0xFF, 0xFF}, /*C */ {0xFD, 0xFB, 0xFF, 0xFF}, /*D */
/*08*/  {0xFB, 0xFB, 0xFF, 0xFF}, /*E */ {0xFD, 0xF7, 0xFF, 0xFF}, /*F */ {0xFD, 0xEF, 0xFF, 0xFF}, /*G */ {0xBF, 0xEF, 0xFF, 0xFF}, /*H */
/*0C*/  {0xDF, 0xFB, 0xFF, 0xFF}, /*I */ {0xBF, 0xF7, 0xFF, 0xFF}, /*J */ {0xBF, 0xFB, 0xFF, 0xFF}, /*K */ {0xBF, 0xFD, 0xFF, 0xFF}, /*L */
/*10*/  {0x7F, 0xFB, 0xFF, 0xFF}, /*M */ {0x7F, 0xF7, 0xFF, 0xFF}, /*N */ {0xDF, 0xFD, 0xFF, 0xFF}, /*O */ {0xDF, 0xFE, 0xFF, 0xFF}, /*P */
/*14*/  {0xFB, 0xFE, 0xFF, 0xFF}, /*Q */ {0xFB, 0xF7, 0xFF, 0xFF}, /*R */ {0xFD, 0xFD, 0xFF, 0xFF}, /*S */ {0xFB, 0xEF, 0xFF, 0xFF}, /*T */
/*18*/  {0xDF, 0xF7, 0xFF, 0xFF}, /*U */ {0xFE, 0xEF, 0xFF, 0xFF}, /*V */ {0xFB, 0xFD, 0xFF, 0xFF}, /*W */ {0xFE, 0xFB, 0xFF, 0xFF}, /*X */
/*1C*/  {0xDF, 0xEF, 0xFF, 0xFF}, /*Y */ {0xFE, 0xFD, 0xFF, 0xFF}, /*Z */ {0xF7, 0xFE, 0xFF, 0xFF}, /*1 */ {0xF7, 0xFD, 0xFF, 0xFF}, /*2 */
/*20*/  {0xF7, 0xFB, 0xFF, 0xFF}, /*3 */ {0xF7, 0xF7, 0xFF, 0xFF}, /*4 */ {0xF7, 0xEF, 0xFF, 0xFF}, /*5 */ {0xEF, 0xEF, 0xFF, 0xFF}, /*6 */
/*24*/  {0xEF, 0xF7, 0xFF, 0xFF}, /*7 */ {0xEF, 0xFB, 0xFF, 0xFF}, /*8 */ {0xEF, 0xFD, 0xFF, 0xFF}, /*9 */ {0xEF, 0xFE, 0xFF, 0xFF}, /*0 */
/*28*/  {0xBF, 0xFE, 0xFF, 0xFF}, /*EN*/ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*2C*/  {0x7F, 0xFE, 0xFF, 0xFF}, /*SP*/ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*30*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*34*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*38*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFE, 0xFE, 0xFF, 0xFF}, /*CS*/ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*3C*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*40*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*44*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*48*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*4C*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*50*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*54*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*58*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*5C*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*60*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*64*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*68*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*7C*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*70*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*74*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*78*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*7C*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*80*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*84*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*88*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*8C*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*90*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*94*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*98*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*9C*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*A0*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*A4*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*A8*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*AC*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*B0*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*B4*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*B8*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*BC*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*C0*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*C4*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*C8*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*DC*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*D0*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*D4*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*D8*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*DC*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*E0*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*E4*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*E8*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*EC*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*F0*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*F4*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*F8*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
/*FC*/  {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */ {0xFF, 0xFF, 0xFF, 0xFF}, /*  */
};

int find_key(key_receive_t* kr, uint8_t value) {
  for(int i = 0; i < sizeof(kr->data.keys); ++i)
    if(kr->data.keys[i] == value)
      return 1;
  return 0;
}

void printline(char n, uint8_t val) {
  int num = val == 0x7F ? 8 : val == 0xBF ? 7 : val == 0xDF ? 6 : val == 0xEF ? 5
   : val == 0xF7 ? 4 : val == 0xFB ? 3 : val == 0xFD ? 2 : val == 0xFE ? 1 : 0;
  if(num)
   printf("%c%02d ", n, num - 1 + (n == 'B' ? 0 : 8));
}

uint8_t not_exist(const uint8_t* preious, const uint8_t cur) {
  for(int i = 0; i < MAX_KEY; ++i)
    if(preious[i] == cur)
      return 0;
  return cur;
}

void presskey(uint8_t keys[MAX_KEY]) {
  static uint8_t preious[MAX_KEY] = {0};
  for(int i = 0; i < MAX_KEY; ++i) {
    if(not_exist(preious, keys[i]))
      zx_keys[membrane[keys[i]].top] &= membrane[keys[i]].tbit;
    if(not_exist(keys, preious[i]))
      zx_keys[membrane[preious[i]].top] = 0xFF;
  }
  memcpy(preious, keys, MAX_KEY);
}

void USBH_HID_EventCallback(USBH_HandleTypeDef* phost) {
  if (USBH_HID_GetDeviceType(phost) == HID_KEYBOARD) {
    key_receive_t* kr = usbh_hid_keyboard(phost);
    printf(
      "lc = 0x%02X, ls = 0x%02X, la = 0x%02X, lg = 0x%02X, "
      "rc = 0x%02X, rs = 0x%02X, ra = 0x%02X, rg = 0x%02X, "
      "k0 = 0x%02X, k1 = 0x%02X, k2 = 0x%02X, "
      "k3 = 0x%02X, k4 = 0x%02X, k5 = 0x%02X\n",
    (int)kr->data.lctrl, (int)kr->data.lshift, (int)kr->data.lalt, (int)kr->data.lgui,
    (int)kr->data.rctrl, (int)kr->data.rshift, (int)kr->data.ralt, (int)kr->data.rgui,
    (int)kr->data.keys[0], (int)kr->data.keys[1], (int)kr->data.keys[2],
    (int)kr->data.keys[3], (int)kr->data.keys[4], (int)kr->data.keys[5]);
    uint8_t tmp = leds.data;
    leds.leds.num = find_key(kr, KEY_KEYPAD_NUM_LOCK_AND_CLEAR) ? !leds.leds.num : leds.leds.num;
    leds.leds.caps = find_key(kr, KEY_CAPS_LOCK) ? !leds.leds.caps : leds.leds.caps;
    leds.leds.scroll = find_key(kr, KEY_SCROLL_LOCK) ? !leds.leds.scroll : leds.leds.scroll;
    if(leds.data != tmp)
      usbh_hid_keboard_led(phost, &leds);
#if 0
    for(int i = 0; i < sizeof(kr->data.keys)/sizeof(*kr->data.keys); ++i) {
      const membrane_t* m = &membrane[(int)kr->data.keys[i]];
      if(m->top != (uint8_t)0xFF) {
        printline('A', m->top); printline('B', m->tbit); printline('A', m->lower); printline('B', m->lbit); printf("\n");
      }
    }
#endif
    presskey(kr->data.keys);
#if 0
    for(int i = 0; i < sizeof(zx_keys); ) {
      printf("0x%02X%c", zx_keys[i], zx_keys[i] != 0xFF ? '*' : ' ');
      i++;
      printf("%c", i % 16 ? ' ' : '\n');
    }
#endif
  }

}
